"use strict";
var _Extension_logger, _Extension_adapter, _Extension_handleTerminating;
Object.defineProperty(exports, "__esModule", { value: true });
exports.Extension = void 0;
const tslib_1 = require("tslib");
const common_1 = require("@heronjs/common");
const adapter_1 = require("./adapter");
class Extension {
    constructor() {
        _Extension_logger.set(this, new common_1.Logger(Extension.name));
        _Extension_adapter.set(this, void 0);
        _Extension_handleTerminating.set(this, (fn) => {
            [`exit`, `SIGINT`, `SIGUSR1`, `SIGUSR2`, `SIGTERM`].forEach((eventType) => {
                process.on(eventType, () => fn());
            });
        });
    }
    activate(args) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (args) {
                yield Promise.resolve().then(() => tslib_1.__importStar(require('express')));
                const { gateKeeper, resolver, shareholder } = args;
                tslib_1.__classPrivateFieldSet(this, _Extension_adapter, new adapter_1.ExpressAdapter(gateKeeper, resolver), "f");
                return new shareholder(tslib_1.__classPrivateFieldGet(this, _Extension_adapter, "f"));
            }
        });
    }
    dispose(args) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (tslib_1.__classPrivateFieldGet(this, _Extension_adapter, "f")) {
                const server = yield tslib_1.__classPrivateFieldGet(this, _Extension_adapter, "f").get();
                tslib_1.__classPrivateFieldGet(this, _Extension_handleTerminating, "f").call(this, () => {
                    server.close(() => {
                        tslib_1.__classPrivateFieldGet(this, _Extension_logger, "f").info(`http server closed!`);
                    });
                });
            }
        });
    }
}
exports.Extension = Extension;
_Extension_logger = new WeakMap(), _Extension_adapter = new WeakMap(), _Extension_handleTerminating = new WeakMap();
